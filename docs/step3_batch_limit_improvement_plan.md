# Step3 배치 제한 개선 구현 계획

## 개요
사용자가 제기한 두 가지 문제점을 해결하기 위한 구현 계획입니다:
1. 상품/이미지 제한이 개별 키워드에 적용되는 문제
2. 청크 단위 브라우저 재시작 시 이전에 처리된 키워드가 제외되지 않는 문제

## 구현 완료 사항

### 1. BatchLimitManager 클래스 구현 ✅
**파일**: `c:\Projects\percenty_project\core\common\batch_limit_manager.py`

**주요 기능**:
- 전체 배치 작업에 대한 상품 및 이미지 제한 관리
- 처리된 상품 및 이미지 수 추적
- 남은 처리 가능 수량 계산
- 배치 제한 도달 여부 확인
- 키워드별 동적 제한 계산
- 현재 상태 로깅

**핵심 메서드**:
- `calculate_keyword_limits()`: 남은 제한량을 고려한 키워드별 제한 계산
- `is_batch_limit_reached()`: 배치 제한 도달 여부 확인
- `add_processed_products()`: 처리된 상품 수 추가
- `log_current_status()`: 현재 상태 로깅

### 2. Step3_1Core 클래스 수정 ✅
**파일**: `c:\Projects\percenty_project\core\steps\step3_1_core.py`

**주요 변경사항**:
- `BatchLimitManager` 임포트 및 초기화
- `execute_step3_1_with_browser_restart()` 메서드에 배치 제한 복구 로직 추가
- `execute_step3_1()` 메서드에 배치 제한 확인 및 조기 종료 로직 추가
- `_process_keyword_with_batch_limit()` 새로운 메서드 추가
- 키워드 처리 후 배치 제한 관리자 상태 업데이트

**핵심 개선사항**:
- 배치 제한에 도달하면 남은 키워드 처리 중단
- 진행 상황 복구 시 누적된 상품/이미지 카운터를 배치 제한 관리자에 설정
- 각 키워드 처리 후 배치 제한 관리자에 결과 반영

### 3. ProductEditorCore3 클래스 수정 ✅
**파일**: `c:\Projects\percenty_project\product_editor_core3.py`

**주요 변경사항**:
- `BatchLimitManager` 임포트
- `process_keyword_with_batch_limits()` 새로운 메서드 추가

**핵심 개선사항**:
- 배치 제한을 고려한 키워드 처리 메서드 제공
- 배치 제한 관리자와의 연동
- 처리 결과를 배치 제한 관리자에 자동 반영

## 해결된 문제점

### 1. 상품/이미지 제한이 개별 키워드에 적용되는 문제 ✅
**해결 방법**:
- `BatchLimitManager`를 통해 전체 배치 작업에 대한 누적 제한 관리
- `calculate_keyword_limits()` 메서드로 남은 제한량을 고려한 키워드별 동적 제한 계산
- 각 키워드 처리 후 누적 카운터 업데이트

**예시**:
- 전체 상품 제한: 10개, 이미지 제한: 20개
- 첫 번째 키워드: 최대 10개 상품, 20개 이미지 처리 가능
- 첫 번째 키워드에서 3개 상품, 8개 이미지 처리 완료
- 두 번째 키워드: 최대 7개 상품, 12개 이미지 처리 가능

### 2. 청크 단위 브라우저 재시작 시 이전 키워드 제외 문제 ✅
**해결 방법**:
- `execute_step3_1_with_browser_restart()` 메서드에서 진행 상황 복구 시 배치 제한 관리자 상태도 함께 복구
- `_resume_from_progress()` 결과를 배치 제한 관리자에 설정
- 완료된 키워드는 자동으로 제외되고 누적 카운터만 복구

**개선된 흐름**:
1. 청크 처리 완료 후 진행 상황 저장
2. 브라우저 재시작
3. 진행 상황 복구 시 완료된 키워드 제외
4. 누적된 상품/이미지 카운터를 배치 제한 관리자에 설정
5. 남은 키워드만 처리 (배치 제한 고려)

## 사용 방법

### 기존 코드와의 호환성
- 기존 `process_keyword_with_individual_modifications()` 메서드는 그대로 유지
- 새로운 `process_keyword_with_batch_limits()` 메서드 추가로 점진적 마이그레이션 가능
- `Step3_1Core`에서 자동으로 새로운 메서드 사용 (있는 경우)

### 배치 실행 시 자동 적용
- `batch_manager.py`에서 `step3_product_limit`와 `step3_image_limit` 설정
- `Step3_1Core` 초기화 시 `BatchLimitManager` 자동 생성
- 키워드 처리 시 배치 제한 자동 적용

## 테스트 시나리오

### 시나리오 1: 상품 제한 테스트
- 상품 제한: 5개, 키워드: ['A', 'B', 'C']
- 키워드 'A'에서 3개 상품 처리
- 키워드 'B'에서 2개 상품 처리 (제한 달성)
- 키워드 'C' 처리 건너뜀

### 시나리오 2: 이미지 제한 테스트
- 이미지 제한: 10개, 키워드: ['X', 'Y']
- 키워드 'X'에서 7개 이미지 번역
- 키워드 'Y'에서 3개 이미지 번역 (제한 달성)

### 시나리오 3: 브라우저 재시작 테스트
- 청크 크기: 2, 키워드: ['A', 'B', 'C', 'D']
- 첫 번째 청크: 'A', 'B' 처리 완료
- 브라우저 재시작
- 두 번째 청크: 'C', 'D'만 처리 (A, B 제외)
- 누적 카운터는 A, B 처리 결과 포함

## 로그 개선사항

### 배치 제한 상태 로깅
```
[INFO] 배치 제한 관리자 초기화: 상품 제한 10개, 이미지 제한 20개
[INFO] 키워드 'A22' 처리 시작 - 최대 상품: 10개, 최대 이미지: 20개
[INFO] 키워드 'A22' 완료 - 처리된 상품: 3개, 이미지: 8개 (누적: 3/10 상품, 8/20 이미지)
[INFO] 키워드 'B06' 처리 시작 - 최대 상품: 7개, 최대 이미지: 12개
[WARNING] 배치 제한 달성 - 남은 키워드 처리 중단
```

### 진행 상황 복구 로깅
```
[INFO] 진행 상황 복구: 완료된 키워드 2개, 누적 상품 5개, 누적 이미지 15개
[INFO] 배치 제한 관리자 상태 복구 완료
[INFO] 남은 처리 가능량: 상품 5개, 이미지 5개
```

## 결론

이번 구현으로 다음과 같은 개선사항이 달성되었습니다:

1. **전체 배치 작업에 대한 통합 제한 관리**: 개별 키워드가 아닌 전체 배치 작업에 대해 상품 및 이미지 제한 적용

2. **정확한 진행 상황 복구**: 브라우저 재시작 시 완료된 키워드 제외 및 누적 카운터 정확한 복구

3. **동적 제한 계산**: 남은 제한량을 고려한 키워드별 최적 제한 계산

4. **향상된 로깅**: 배치 제한 상태 및 진행 상황을 명확하게 추적 가능

5. **호환성 유지**: 기존 코드와의 호환성을 유지하면서 점진적 개선 가능

이제 Step3 배치 작업에서 사용자가 설정한 상품 및 이미지 제한이 전체 배치 작업에 대해 정확하게 적용되며, 브라우저 재시작 시에도 올바른 진행 상황 관리가 가능합니다.