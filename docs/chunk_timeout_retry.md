# 청크별 타임아웃 및 재시도 시스템

## 개요

기존의 배치 전체에 대한 단일 타임아웃 방식에서 청크별 개별 타임아웃과 재시도 메커니즘을 도입하여 배치 처리의 안정성과 효율성을 향상시켰습니다.

## 주요 개선사항

### 1. 청크별 타임아웃 계산

#### 기존 방식의 문제점
- 전체 배치에 대한 고정 타임아웃 (30분~60분)
- 청크 단위 처리에도 불구하고 전체 배치 기준 타임아웃 적용
- 오류 발생 시 늦은 감지로 인한 리소스 낭비

#### 개선된 방식
- **단계별 아이템당 처리 시간 기반 계산**
  - Step 1, 4, 5_x: 135초/아이템 (2.25분)
  - Step 2_x: 270초/아이템 (4.5분)
  - Step 3_x: 540초/아이템 (9분)

- **청크별 타임아웃 공식**
  ```
  청크_타임아웃 = (청크크기 × 아이템당_시간) + 오버헤드(300초)
  ```

- **안전 장치**
  - 최소 타임아웃: 600초 (10분)
  - 최대 타임아웃: 7200초 (2시간)

### 2. 청크별 재시도 메커니즘

#### 재시도 대상 오류
- **일시적/복구 가능한 오류**
  - 네트워크 연결 문제
  - 서버 일시적 응답 지연
  - 브라우저 일시적 오류
  - UI 로딩 지연
  - 예상치 못한 모달/팝업

#### 재시도 설정
- **최대 재시도 횟수**: 2회
- **재시도 간격**: 30초
- **브라우저 상태 확인**: 각 재시도 전 브라우저 응답성 검증

#### Step별 재시도 구현

##### Step 1 재시도
```python
def _retry_failed_chunk(self, account_id, chunk_number, chunk_size, browser_id, account_logger):
    # 브라우저 복구 시도
    # Step1Core를 통한 청크 재실행
    # 성공 조건: processed > 0
```

##### Step 4 재시도
```python
def _retry_failed_chunk_step4(self, account_id, chunk_number, chunk_size, browser_id, account_logger, driver):
    # 기존 드라이버 상태 확인
    # run_step4_for_account를 통한 청크 재실행
    # 성공 조건: success=True, skipped=False, processed_count > 0
```

### 3. 브라우저 복구 시스템

#### 복구 프로세스
1. **상태 확인**: `driver.title` 호출로 브라우저 응답성 검증
2. **재시작 결정**: 응답 없을 시 브라우저 재시작
3. **새 브라우저 생성**: 기존 브라우저 종료 후 새 인스턴스 생성
4. **로그인 복구**: 계정 정보를 통한 자동 로그인

## 기대 효과

### 1. 빠른 오류 감지
- 청크별 타임아웃으로 오류를 조기에 감지
- 전체 배치 실패 전에 문제 청크만 격리

### 2. 리소스 효율성
- 불필요한 대기 시간 최소화
- 시스템 리소스 효율적 활용

### 3. 안정성 향상
- 일시적 오류에 대한 자동 복구
- 브라우저 상태 이상 시 자동 재시작

### 4. 모니터링 개선
- 청크별 상세 로그
- 재시도 과정 추적
- 실패 원인 분석 용이

## 설정 예시

### 청크 크기별 타임아웃 예시

| 단계 | 청크크기 | 아이템당 시간 | 청크 타임아웃 | 총 시간 (20개 청크) |
|------|----------|---------------|---------------|--------------------|
| Step 1 | 20 | 135초 | 50분 | 16.7시간 |
| Step 4 | 20 | 135초 | 50분 | 16.7시간 |
| Step 3_1 | 10 | 540초 | 95분 | 31.7시간 |

### 재시도 시나리오 예시

```
청크 3/10 실행 중 오류 발생
├── 재시도 1/2 시작 (30초 대기 후)
│   ├── 브라우저 상태 확인: 응답 없음
│   ├── 브라우저 재시작 및 로그인
│   └── 청크 재실행: 실패
├── 재시도 2/2 시작 (30초 대기 후)
│   ├── 브라우저 상태 확인: 정상
│   └── 청크 재실행: 성공 (15개 처리)
└── 청크 3 최종 성공
```

## 구현 파일

- `core/periodic_execution_manager.py`: 청크별 타임아웃 계산
- `batch/batch_manager.py`: 청크별 재시도 로직
- `core/steps/step1_core.py`: Step 1 실행 로직
- `core/steps/step4_core.py`: Step 4 실행 로직

## 향후 개선 방향

1. **적응형 타임아웃**: 과거 실행 이력 기반 동적 타임아웃 조정
2. **재시도 전략 고도화**: 오류 유형별 차별화된 재시도 전략
3. **성능 메트릭**: 청크별 처리 시간 통계 수집
4. **알림 시스템**: 연속 실패 시 관리자 알림