# 4단계 자동화 코어 개발 문서

## 개요

4단계 자동화는 일괄 번역 워크플로우를 통해 서버별 상품을 번역하고 대기 그룹으로 이동시키는 기능입니다.

## 주요 컴포넌트

### 1. PercentyNewStep4 클래스
- **파일**: `percenty_new_step4.py`
- **역할**: 4단계 자동화의 메인 진입점
- **주요 메서드**: `run_step4_automation()`

### 2. Step4Core 클래스 (신규)
- **파일**: `step4_core.py`
- **역할**: GUI에서 사용할 4단계 자동화 래퍼
- **주요 기능**:
  - PercentyNewStep4 클래스 래핑
  - 계정 관리 및 로그인 처리
  - 안전한 리소스 정리
  - GUI 환경에 최적화된 결과 반환

### 2. ProductEditorCore4 클래스
- **파일**: `product_editor_core4.py`
- **역할**: 일괄 번역 워크플로우 실행
- **주요 메서드**: 
  - `execute_bulk_translation_workflow()`: 전체 워크플로우 실행
  - `_execute_single_server_workflow()`: 단일 서버 처리
  - `_handle_bulk_translation()`: 일괄 번역 처리

### 3. UploadUtils 클래스
- **파일**: `upload_utils.py`
- **역할**: 일괄 번역 모달 처리
- **주요 메서드**:
  - `handle_batch_translate_modal()`: 번역 모달 처리
  - `close_batch_translate_modal()`: 모달 닫기

## 워크플로우 구조

### 전체 프로세스
```
서버1 → 대기1
서버2 → 대기2  
서버3 → 대기3
```

### 단일 서버 처리 단계
1. **그룹 선택**: 해당 서버 그룹 선택
2. **페이지 설정**: 50개씩 보기 설정
3. **상품 확인**: 상품 존재 여부 확인
4. **전체 선택**: 모든 상품 선택
5. **일괄 번역**: 번역 처리
6. **그룹 이동**: 대기 그룹으로 이동

## 예외 처리 시나리오

### 1. 상품이 없는 경우
- **감지**: 상품수 0개 확인
- **처리**: 워크플로우 스킵, 다음 서버로 진행
- **로그**: INFO 레벨로 정상 스킵 기록

### 2. 번역 횟수 부족
- **감지**: 사용 가능한 번역 횟수 < 선택된 상품 수
- **처리**: 모달 닫기, 워크플로우 중단
- **로그**: WARNING 레벨로 정상 중단 기록

### 3. 모달 처리 실패
- **감지**: 번역 횟수 확인 불가, 선택 상품 수 확인 불가
- **처리**: 모달 닫기, 워크플로우 중단
- **로그**: WARNING 레벨로 중단 기록

## 반환값 체계

### 성공 케이스
- `True`: 모든 단계 성공적으로 완료

### 실패/중단 케이스
- `False`: 번역 불가능, 상품 없음, 오류 발생

## 로그 레벨 정책

### INFO
- 정상적인 진행 상황
- 상품 없음으로 인한 스킵
- 성공적인 완료

### WARNING
- 번역 횟수 부족으로 인한 중단
- 모달 처리 실패로 인한 중단

### ERROR
- 실제 시스템 오류
- 예상치 못한 예외 상황

## GUI 연결 인터페이스

### 1. Step4Core 모듈 사용
```python
# GUI에서 4단계 실행 시 사용할 인터페이스
from core.steps.step4_core import run_step4_for_account

# 계정별 4단계 자동화 실행
result = run_step4_for_account(
    account_id="1",  # 계정 ID (1, 2, 3, 4 등)
    quantity=10,     # 배치 설정 수량 (실제로는 사용되지 않음)
    headless=False   # 헤드리스 모드 여부
)
```

### 2. GUI 통합 방식
**percenty_gui_advanced.py**에서 4단계 실행 시:
```python
# Step 4 처리 (step4_core.py 사용)
elif step == '4':
    cmd = [
        sys.executable,
        os.path.join(project_root, "core", "steps", "step4_core.py"),
        "--account", account,
        "--quantity", quantity
    ]
    # 헤드리스 모드 옵션 추가
    if self.headless_var.get():
        cmd.extend(["--headless"])
```

### 메인 실행 메서드
```python
def run_step4_automation(self) -> bool:
    """
    4단계 자동화 실행
    
    Returns:
        bool: 성공 여부
    """
```

### 상태 확인 메서드
- 현재 진행 상황 확인
- 번역 가능 횟수 확인
- 서버별 상품 수 확인

### 설정 가능한 옵션
- 처리할 서버 선택 (서버1, 서버2, 서버3)
- 페이지 크기 설정 (기본: 50개씩)
- 재시도 횟수 설정

## 의존성

### 필수 모듈
- `selenium`: 웹 자동화
- `logging`: 로그 기록
- `time`: 대기 처리

### 내부 의존성
- `dropdown_utils4`: 드롭다운 처리
- `upload_utils`: 업로드 및 모달 처리
- `channel_talk_utils`: 채널톡 처리

## 테스트 시나리오

### 정상 케이스
1. 모든 서버에 상품이 있고 번역 횟수가 충분한 경우
2. 일부 서버에만 상품이 있는 경우
3. 번역 횟수가 일부 서버만 처리 가능한 경우

### 예외 케이스
1. 모든 서버에 상품이 없는 경우
2. 번역 횟수가 전혀 없는 경우
3. 네트워크 오류로 모달 처리 실패

## 성능 고려사항

### 대기 시간
- 페이지 로딩: 2초
- 모달 처리: 1초
- 상품 수 변경 확인: 최대 8초

### 메모리 사용
- 브라우저 인스턴스 재사용
- 불필요한 객체 생성 최소화

## 향후 개선 방향

### 1. 병렬 처리
- 서버별 독립적 처리 가능성 검토
- 멀티스레딩 적용 고려

### 2. 설정 관리
- 외부 설정 파일 분리
- 환경별 설정 관리

### 3. 모니터링
- 실시간 진행 상황 추적
- 성능 메트릭 수집

### 4. 복구 기능
- 중단된 지점부터 재시작
- 부분 실패 시 롤백

## 테스팅 & 디버깅

### 테스트 스크립트
- **파일**: `test_step4_core.py`
- **용도**: step4_core.py 기능 테스트
- **실행 방법**:
  ```bash
  # 기본 테스트 (계정 1번, GUI 모드)
  python test_step4_core.py
  
  # 특정 계정으로 테스트
  python test_step4_core.py --account 2
  
  # 헤드리스 모드로 테스트
  python test_step4_core.py --account 1 --headless
  ```

### 로그 레벨 정책
- **INFO**: 정상적인 워크플로우 진행 상황
- **WARNING**: 번역 가능한 상품 부족으로 인한 스킵
- **ERROR**: 실제 오류 상황 (현재는 사용하지 않음)

### 디버깅 포인트
- 번역 가능한 상품 수 확인
- 서버별 상품 수 비교
- 모달 창 감지 및 처리
- 브라우저 상태 확인

## 문제 해결 가이드

### 자주 발생하는 문제

1. **모달이 닫히지 않는 경우**
   - 선택자 업데이트 필요
   - DOM 구조 변경 확인

2. **상품 수 확인 실패**
   - 페이지 로딩 대기 시간 증가
   - 선택자 정확성 확인

3. **그룹 선택 실패**
   - 드롭다운 열기 재시도
   - 스크롤 위치 조정

### 디버깅 팁
- 로그 레벨을 DEBUG로 설정
- 스크린샷 캡처 활용
- 단계별 수동 확인

---

*문서 작성일: 2025-06-16*
*최종 수정일: 2025-06-16*